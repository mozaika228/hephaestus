<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hephaestus Desktop</title>
    <style>
      body {
        margin: 0;
        font-family: "Space Grotesk", sans-serif;
        background: radial-gradient(circle at top, rgba(12, 40, 35, 0.7), transparent 55%),
          linear-gradient(180deg, #020403 0%, #020807 100%);
        color: #e6fff8;
        min-height: 100vh;
        padding: 32px;
      }
      .panel {
        border: 1px solid rgba(50, 255, 190, 0.2);
        padding: 24px 32px;
        border-radius: 20px;
        background: rgba(6, 20, 18, 0.7);
        max-width: 900px;
        margin: 0 auto;
        box-shadow: 0 0 30px rgba(39, 245, 184, 0.12);
      }
      h1 {
        font-family: "Oxanium", sans-serif;
        color: #27f5b8;
      }
      .chat {
        display: grid;
        gap: 10px;
        max-height: 260px;
        overflow-y: auto;
        margin: 16px 0;
      }
      .bubble {
        padding: 12px 14px;
        border-radius: 14px;
        background: rgba(8, 22, 18, 0.7);
        border: 1px solid rgba(39, 245, 184, 0.2);
        max-width: 80%;
      }
      .bubble.user {
        margin-left: auto;
        background: rgba(39, 245, 184, 0.12);
        border: 1px solid rgba(39, 245, 184, 0.4);
      }
      .row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
      }
      input, select, button {
        font-family: "Space Grotesk", sans-serif;
        background: rgba(3, 10, 8, 0.6);
        border: 1px solid rgba(50, 255, 190, 0.16);
        color: #e6fff8;
        padding: 10px 12px;
        border-radius: 12px;
      }
      button {
        cursor: pointer;
      }
      .file-row {
        display: flex;
        gap: 12px;
        margin-top: 12px;
        align-items: center;
      }
      .tag {
        font-size: 0.85rem;
        color: rgba(220, 255, 245, 0.72);
      }
      .analysis {
        margin-top: 14px;
        padding: 12px;
        border: 1px solid rgba(39, 245, 184, 0.2);
        border-radius: 12px;
        background: rgba(4, 14, 12, 0.6);
      }
    </style>
  </head>
  <body>
    <div class="panel">
      <h1>Hephaestus Desktop</h1>
      <p>Десктоп консоль подключена к API.</p>

      <div class="row">
        <select id="provider">
          <option value="openai">OpenAI</option>
          <option value="azure">Azure OpenAI</option>
          <option value="local">Local</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <div class="chat" id="chat"></div>
      <div class="row">
        <input id="message" placeholder="Введите запрос..." />
        <button id="send">Отправить</button>
      </div>

      <div class="file-row">
        <input type="file" id="file" />
        <button id="upload">Загрузить файл</button>
        <button id="analyze">Анализировать</button>
        <span class="tag" id="fileTag"></span>
      </div>

      <div class="analysis" id="analysis"></div>
    </div>

    <script>
      const apiBase = "http://localhost:4000";
      const chat = document.getElementById("chat");
      const provider = document.getElementById("provider");
      const messageInput = document.getElementById("message");
      const sendButton = document.getElementById("send");
      const uploadButton = document.getElementById("upload");
      const analyzeButton = document.getElementById("analyze");
      const fileInput = document.getElementById("file");
      const fileTag = document.getElementById("fileTag");
      const analysisBox = document.getElementById("analysis");
      let fileInfo = null;

      function addBubble(text, role) {
        const div = document.createElement("div");
        div.className = `bubble ${role}`;
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        return div;
      }

      async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;
        messageInput.value = "";
        addBubble(text, "user");
        const assistant = addBubble("", "assistant");

        const response = await fetch(`${apiBase}/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text, provider: provider.value, fileId: fileInfo?.providerFileId })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          let idx;
          while ((idx = buffer.indexOf("\n\n")) >= 0) {
            const raw = buffer.slice(0, idx);
            buffer = buffer.slice(idx + 2);
            raw.split("\n").forEach((line) => {
              if (!line.startsWith("data:")) return;
              const payload = line.slice(5).trim();
              if (!payload) return;
              try {
                const event = JSON.parse(payload);
                if (event.type === "delta") {
                  assistant.textContent += event.text;
                }
              } catch {
                // ignore
              }
            });
          }
        }
      }

      async function uploadFile() {
        if (!fileInput.files.length) return;
        const form = new FormData();
        form.append("file", fileInput.files[0]);
        const response = await fetch(`${apiBase}/files/ingest`, { method: "POST", body: form });
        const payload = await response.json();
        if (payload.ok) {
          fileInfo = payload.file;
          fileTag.textContent = `Файл: ${payload.file.name}`;
          analysisBox.textContent = "";
        }
      }

      async function analyzeFile() {
        if (!fileInfo?.id) return;
        const response = await fetch(`${apiBase}/files/${fileInfo.id}/analyze`, { method: "POST" });
        const payload = await response.json();
        if (payload.ok) {
          analysisBox.textContent = payload.analysis?.text || payload.analysis?.error || "Нет данных";
        }
      }

      sendButton.addEventListener("click", sendMessage);
      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });
      uploadButton.addEventListener("click", uploadFile);
      analyzeButton.addEventListener("click", analyzeFile);
    </script>
  </body>
</html>
